<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Control Panel - Video Sync</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }
    
    h1 {
      color: #4CAF50;
      margin-bottom: 5px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #888;
      font-size: 16px;
    }
    
    .panel {
      background: #252525;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h2 {
      color: #4CAF50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
      font-size: 20px;
    }
    
    .file-browser {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      background: #1e1e1e;
      border-radius: 6px;
      padding: 10px;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      transition: background 0.2s;
    }
    
    .file-item:hover {
      background: #2a2a2a;
    }
    
    .file-name {
      flex-grow: 1;
      font-size: 16px;
      display: flex;
      align-items: center;
    }
    
    .hevc-warning-icon {
      color: #ff6b6b;
      margin-left: 8px;
      cursor: help;
    }
    
    .file-actions button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .file-actions button:hover {
      background: #3e8e41;
    }
    
    .playlist {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      background: #1e1e1e;
      border-radius: 6px;
      padding: 10px;
    }
    
    .playlist-item {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
      transition: background 0.2s;
    }
    
    .playlist-item.main {
      background: #2c5f2d;
      border-left: 4px solid #4CAF50;
    }
    
    .playlist-info {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .main-badge {
      background: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .playlist-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .playlist-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .btn-set-main {
      background: #2196F3;
      color: white;
    }
    
    .btn-remove {
      background: #f44336;
      color: white;
    }
    
    .track-selection {
      background: #2a2a2a;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .track-group {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .track-group label {
      min-width: 100px;
      margin-right: 10px;
    }
    
    .track-group select {
      flex-grow: 1;
      padding: 6px;
      background: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 4px;
    }
    
    .control-group {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    label {
      font-weight: bold;
      min-width: 120px;
    }
    
    input[type="number"] {
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #e0e0e;
      width: 100px;
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn-launch {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    .btn-launch:hover {
      background: #3e8e41;
    }
    
    .remote-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .remote-btn {
      padding: 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      background: #333;
      color: #e0e0e0;
      transition: background 0.2s;
    }
    
    .remote-btn:hover {
      background: #444;
    }
    
    .btn-play {
      background: #4CAF50;
      grid-column: 2;
    }
    
    .btn-pause {
      background: #FF9800;
      grid-column: 2;
    }
    
    .btn-skip-back {
      background: #2196F3;
    }
    
    .btn-skip-forward {
      background: #2196F3;
    }
    
    .seek-controls {
      grid-column: 1 / span 3;
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .seek-controls input {
      flex-grow: 1;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1e1e1e;
      color: #e0e0e0;
      width: 100px;
    }
    
    .btn-seek {
      background: #9C27B0;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .status-message {
      text-align: center;
      padding: 12px;
      margin-top: 20px;
      border-radius: 4px;
      display: none;
    }
    
    .status-success {
      background: #2c5f2d;
      display: block;
    }
    
    .status-error {
      background: #f44336;
      display: block;
    }
    
    .status-warning {
      background: #FF9800;
      color: #333;
      display: block;
    }
    
    .status-info {
      background: #2196F3;
      display: block;
    }
    
    .hidden {
      display: none;
    }
    
    .visible {
      display: block;
    }
    
    .empty-message {
      text-align: center;
      padding: 20px;
      color: #888;
      font-style: italic;
    }
    
    .hevc-warning {
      background: #f44336;
      color: white;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    
    .loading-indicator {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    .mkv-info {
      background: #2196F3;
      color: white;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .remote-controls {
        grid-template-columns: 1fr;
      }
      
      .btn-play, .btn-pause, .btn-skip-back, .btn-skip-forward {
        grid-column: 1;
      }
      
      .seek-controls {
        grid-column: 1;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Video Sync Admin Panel</h1>
    <p class="subtitle">Manage playlists and control playback</p>
  </header>
  
  <!-- HEVC Warning Banner -->
  <div id="hevc-warning" class="hevc-warning hidden">
    <strong>⚠️ HEVC Codec Warning:</strong> MKV files often use HEVC (H.265) codecs which cannot be played on browsers without HEVC extensions. This affects all clients including the host. Users may need to install HEVC codecs from the Microsoft Store for proper playback.
  </div>
  
  <!-- MKV Info Banner -->
  <div id="mkv-info" class="mkv-info hidden">
    <strong>ℹ️ MKV File Information:</strong> MKV files support multiple audio and subtitle tracks. You can select which tracks to use by default for each MKV file in your playlist.
  </div>
  
  <div id="setup-section">
    <div class="panel">
      <h2>Available Media Files</h2>
      <div class="file-browser" id="file-browser">
        <div class="empty-message">Loading files...</div>
      </div>
    </div>
    
    <div class="panel">
      <h2>Playlist</h2>
      <div class="playlist" id="playlist-container">
        <div class="empty-message">No files in playlist yet</div>
      </div>
      
      <div class="control-group">
        <label for="start-time">Main Video Start (s):</label>
        <input type="number" id="start-time" min="0" value="0">
      </div>
      
      <div class="action-buttons">
        <button class="btn-launch" id="launch-btn">Launch Playlist</button>
      </div>
    </div>
  </div>
  
  <div id="remote-section" class="hidden">
    <div class="panel">
      <h2>Remote Control</h2>
      <div class="remote-controls">
        <button class="remote-btn btn-skip-back" id="skip-back-btn">↩ <span id="skip-back-text">5s</span></button>
        <button class="remote-btn btn-play" id="play-btn">Play</button>
        <button class="remote-btn btn-pause" id="pause-btn">Pause</button>
        <button class="remote-btn btn-skip-forward" id="skip-forward-btn">↪ <span id="skip-forward-text">5s</span></button>
        
        <div class="seek-controls">
          <input type="number" id="seek-time" placeholder="Time in seconds" min="0">
          <button class="btn-seek" id="seek-btn">Seek</button>
        </div>
      </div>
      
      <div class="status-message" id="status-message"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let playlist = [];
    let mainVideoIndex = -1;
    let skipSeconds = 5;

    // Fetch available files from server
    async function loadFiles() {
      try {
        const response = await fetch('/api/files');
        const files = await response.json();
        displayFiles(files);
      } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('file-browser').innerHTML = 
          '<div class="empty-message">Error loading files. Check server connection.</div>';
      }
    }

    // Display files in the file browser
    function displayFiles(files) {
      const fileBrowser = document.getElementById('file-browser');
      
      if (files.length === 0) {
        fileBrowser.innerHTML = '<div class="empty-message">No media files found in videos folder</div>';
        return;
      }
      
      fileBrowser.innerHTML = '';
      
      files.forEach((file) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const fileNameDiv = document.createElement('div');
        fileNameDiv.className = 'file-name';
        fileNameDiv.innerHTML = file.filename;
        
        // Show warning for all MKV files (simplified approach)
        if (file.filename.endsWith('.mkv')) {
          const warningIcon = document.createElement('span');
          warningIcon.className = 'hevc-warning-icon';
          warningIcon.title = 'MKV files may contain HEVC codec which may not play on all devices';
          warningIcon.innerHTML = '⚠️';
          fileNameDiv.appendChild(warningIcon);
        }
        
        const fileActions = document.createElement('div');
        fileActions.className = 'file-actions';
        
        const addButton = document.createElement('button');
        addButton.textContent = 'Add to Playlist';
        addButton.onclick = () => addToPlaylist(file);
        
        fileActions.appendChild(addButton);
        fileItem.appendChild(fileNameDiv);
        fileItem.appendChild(fileActions);
        
        fileBrowser.appendChild(fileItem);
      });
    }

    // Add a file to the playlist
    async function addToPlaylist(file) {
      if (!playlist.some(item => item.filename === file.filename)) {
        // Create a copy of the file object to avoid reference issues
        const fileCopy = {...file};
        
        // For MKV files, fetch track information
        if (fileCopy.filename.endsWith('.mkv')) {
          try {
            // Show loading indicator
            const addButton = event.target;
            const originalText = addButton.textContent;
            addButton.disabled = true;
            addButton.innerHTML = 'Adding... <span class="loading-indicator"></span>';
            
            const response = await fetch(`/api/tracks/${encodeURIComponent(fileCopy.filename)}`);
            if (response.ok) {
              const tracks = await response.json();
              // Ensure tracks has the expected structure
              fileCopy.tracks = {
                audio: tracks.audio || [],
                subtitles: tracks.subtitles || []
              };
            } else {
              console.error('Error fetching track info:', response.statusText);
              fileCopy.tracks = { audio: [], subtitles: [] };
            }
            
            // Restore button
            addButton.disabled = false;
            addButton.textContent = originalText;
          } catch (error) {
            console.error('Error fetching track info:', error);
            fileCopy.tracks = { audio: [], subtitles: [] };
            
            // Restore button in case of error
            const addButton = event.target;
            addButton.disabled = false;
            addButton.textContent = 'Add to Playlist';
          }
        } else {
          // For non-MKV files, set empty tracks
          fileCopy.tracks = { audio: [], subtitles: [] };
        }
        
        // Mark all MKV files as potentially having HEVC
        if (fileCopy.filename.endsWith('.mkv')) {
          fileCopy.usesHEVC = true;
        } else {
          fileCopy.usesHEVC = false;
        }
        
        playlist.push(fileCopy);
        updatePlaylistDisplay();
        
        // Show warning if there are MKV files
        updateHevcWarning();
        
        // Show MKV info if there are MKV files
        updateMkvInfo();
      }
    }

    // Remove a file from the playlist
    function removeFromPlaylist(index) {
      playlist.splice(index, 1);
      if (mainVideoIndex === index) {
        mainVideoIndex = -1;
      } else if (mainVideoIndex > index) {
        mainVideoIndex--;
      }
      updatePlaylistDisplay();
      
      // Update warning if MKV files were removed
      updateHevcWarning();
      updateMkvInfo();
    }

    // Set a video as the main video
    function setAsMain(index) {
      const item = playlist[index];
      
      // Check if it's an MKV file and show info
      if (item.filename.endsWith('.mkv')) {
        showStatus('Note: MKV files may have limited browser support. Ensure proper codecs are installed.', 'info');
      }
      
      mainVideoIndex = index;
      updatePlaylistDisplay();
    }

    // Update the playlist display
    function updatePlaylistDisplay() {
      const playlistContainer = document.getElementById('playlist-container');
      
      if (playlist.length === 0) {
        playlistContainer.innerHTML = '<div class="empty-message">No files in playlist yet</div>';
        return;
      }
      
      playlistContainer.innerHTML = '';
      
      playlist.forEach((item, index) => {
        const playlistItem = document.createElement('div');
        playlistItem.className = `playlist-item ${index === mainVideoIndex ? 'main' : ''}`;
        
        // Playlist info section
        const playlistInfo = document.createElement('div');
        playlistInfo.className = 'playlist-info';
        
        const fileName = document.createElement('span');
        fileName.textContent = item.filename;
        
        if (item.filename.endsWith('.mkv')) {
          const warningIcon = document.createElement('span');
          warningIcon.className = 'hevc-warning-icon';
          warningIcon.title = 'MKV files may contain HEVC codec which may not play on all devices';
          warningIcon.innerHTML = '⚠️';
          fileName.appendChild(warningIcon);
        }
        
        playlistInfo.appendChild(fileName);
        
        if (index === mainVideoIndex) {
          const mainBadge = document.createElement('span');
          mainBadge.className = 'main-badge';
          mainBadge.textContent = 'Main';
          playlistInfo.appendChild(mainBadge);
        }
        
        // Playlist actions section
        const playlistActions = document.createElement('div');
        playlistActions.className = 'playlist-actions';
        
        if (index !== mainVideoIndex) {
          const setMainButton = document.createElement('button');
          setMainButton.className = 'btn-set-main';
          setMainButton.textContent = 'Set Main';
          setMainButton.onclick = () => setAsMain(index);
          playlistActions.appendChild(setMainButton);
        }
        
        const removeButton = document.createElement('button');
        removeButton.className = 'btn-remove';
        removeButton.textContent = 'Remove';
        removeButton.onclick = () => removeFromPlaylist(index);
        playlistActions.appendChild(removeButton);
        
        // Track selection section (for MKV files)
        let trackSelectionHtml = '';
        if (item.filename.endsWith('.mkv') && item.tracks) {
          trackSelectionHtml = `
            <div class="track-selection">
              <div class="track-group">
                <label>Audio Track:</label>
                <select id="audio-track-${index}" class="audio-track-select">
                  ${item.tracks.audio && item.tracks.audio.length > 0 ? 
                    item.tracks.audio.map((track, trackIndex) => 
                      `<option value="${trackIndex}" ${track.default ? 'selected' : ''}>${track.language} - ${track.title || `Track ${trackIndex}`}</option>`
                    ).join('') : 
                    '<option value="0">Default Audio</option>'
                  }
                </select>
              </div>
              <div class="track-group">
                <label>Subtitle Track:</label>
                <select id="subtitle-track-${index}" class="subtitle-track-select">
                  <option value="-1" selected>None</option>
                  ${item.tracks.subtitles && item.tracks.subtitles.length > 0 ? 
                    item.tracks.subtitles.map((track, trackIndex) => 
                      `<option value="${trackIndex}" ${track.default ? 'selected' : ''}>${track.language} - ${track.title || `Track ${trackIndex}`}</option>`
                    ).join('') : ''
                  }
                </select>
              </div>
            </div>
          `;
        }
        
        playlistItem.appendChild(playlistInfo);
        playlistItem.appendChild(playlistActions);
        
        if (trackSelectionHtml) {
          playlistItem.innerHTML += trackSelectionHtml;
        }
        
        playlistContainer.appendChild(playlistItem);
      });
    }

    // Update HEVC warning visibility
    function updateHevcWarning() {
      const hasMKVFiles = playlist.some(item => item.filename.endsWith('.mkv') && item.usesHEVC);
      const warningElement = document.getElementById('hevc-warning');
      
      if (hasMKVFiles) {
        warningElement.classList.remove('hidden');
      } else {
        warningElement.classList.add('hidden');
      }
    }

    // Update MKV info visibility
    function updateMkvInfo() {
      const hasMKVFiles = playlist.some(item => item.filename.endsWith('.mkv'));
      const infoElement = document.getElementById('mkv-info');
      
      if (hasMKVFiles) {
        infoElement.classList.remove('hidden');
      } else {
        infoElement.classList.add('hidden');
      }
    }

    // Launch the playlist
    function launchPlaylist() {
      if (playlist.length === 0) {
        showStatus('Playlist is empty!', 'error');
        return;
      }
      
      if (mainVideoIndex === -1) {
        showStatus('Please select a main video!', 'error');
        return;
      }
      
      proceedWithLaunch();
    }

    // Proceed with launching the playlist
    async function proceedWithLaunch() {
      const startTime = document.getElementById('start-time').value || 0;
      
      // Collect track selections for MKV files
      const playlistWithTracks = playlist.map((item, index) => {
        const playlistItem = { ...item };
        
        if (item.filename.endsWith('.mkv')) {
          const audioSelect = document.getElementById(`audio-track-${index}`);
          const subtitleSelect = document.getElementById(`subtitle-track-${index}`);
          
          if (audioSelect) {
            playlistItem.selectedAudioTrack = parseInt(audioSelect.value);
          }
          
          if (subtitleSelect) {
            playlistItem.selectedSubtitleTrack = parseInt(subtitleSelect.value);
          }
        }
        
        return playlistItem;
      });
      
      // Show loading status
      showStatus('Setting up playlist...', 'info');
      
      // Send playlist to server
      socket.emit('set-playlist', {
        playlist: playlistWithTracks,
        mainVideoIndex: parseInt(mainVideoIndex),
        startTime: parseFloat(startTime)
      });
    }

    // Show status message
    function showStatus(message, type) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      
      setTimeout(() => {
        statusEl.className = 'status-message';
      }, 5000);
    }

    // Remote control functions
    function playVideo() {
      socket.emit('control', { 
        action: 'playpause', 
        state: true
      });
    }

    function pauseVideo() {
      socket.emit('control', { 
        action: 'playpause', 
        state: false
      });
    }

    function skipBack() {
      socket.emit('control', { 
        action: 'skip', 
        direction: 'back', 
        seconds: skipSeconds 
      });
    }

    function skipForward() {
      socket.emit('control', { 
        action: 'skip', 
        direction: 'forward', 
        seconds: skipSeconds 
      });
    }

    function seekTo() {
      const time = document.getElementById('seek-time').value;
      if (time) {
        socket.emit('control', { 
          action: 'seek', 
          time: parseFloat(time) 
        });
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadFiles();
      
      // Setup event listeners
      document.getElementById('launch-btn').addEventListener('click', launchPlaylist);
      document.getElementById('play-btn').addEventListener('click', playVideo);
      document.getElementById('pause-btn').addEventListener('click', pauseVideo);
      document.getElementById('skip-back-btn').addEventListener('click', skipBack);
      document.getElementById('skip-forward-btn').addEventListener('click', skipForward);
      document.getElementById('seek-btn').addEventListener('click', seekTo);
      
      // Get config for skip seconds
      socket.emit('get-config');
    });

    // Handle config from server
    socket.on('config', (config) => {
      skipSeconds = config.skipSeconds || 5;
      document.getElementById('skip-back-text').textContent = `${skipSeconds}s`;
      document.getElementById('skip-forward-text').textContent = `${skipSeconds}s`;
    });

    // Handle playlist confirmation
    socket.on('playlist-set', (data) => {
      if (data.success) {
        showStatus(data.message || 'Playlist launched successfully!', 'success');
        
        // Switch to remote view after a brief delay
        setTimeout(() => {
          document.getElementById('setup-section').classList.add('hidden');
          document.getElementById('remote-section').classList.remove('hidden');
        }, 2000);
      } else {
        showStatus(data.message || 'Failed to launch playlist!', 'error');
      }
    });
  </script>
</body>
</html>
